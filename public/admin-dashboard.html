<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
  <meta charset="UTF-8">
  <title>CRMS - Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Bootstrap CSS (CDN) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #1f2937 0, #020617 45%, #000000 100%);
      color: #e5e7eb;
      display: flex;
      flex-direction: column;
    }

    .navbar {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .dashboard-wrapper {
      flex: 1;
      padding: 2rem 1rem 2.5rem;
    }

    .glass-card {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.35);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      border-radius: 1.25rem;
    }

    .btn-primary {
      background: linear-gradient(135deg, #0ea5e9, #6366f1);
      border: none;
      box-shadow: 0 10px 25px rgba(56, 189, 248, 0.35);
    }

    .btn-primary:hover {
      background: linear-gradient(135deg, #0284c7, #4f46e5);
      box-shadow: 0 12px 30px rgba(56, 189, 248, 0.5);
    }

    .btn-outline-light {
      border-color: rgba(148, 163, 184, 0.7);
      color: #e5e7eb;
    }

    .btn-outline-light:hover {
      background-color: rgba(148, 163, 184, 0.15);
      border-color: #e5e7eb;
      color: #f9fafb;
    }

    .badge-soft {
      background: rgba(56, 189, 248, 0.08);
      border: 1px solid rgba(56, 189, 248, 0.4);
      color: #e0f2fe;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .hero-blur-orb {
      position: absolute;
      width: 220px;
      height: 220px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(56, 189, 248, 0.18), transparent 60%);
      filter: blur(2px);
      top: -40px;
      right: -30px;
      z-index: -1;
    }

    .hero-blur-orb-2 {
      position: absolute;
      width: 200px;
      height: 200px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(129, 140, 248, 0.2), transparent 60%);
      filter: blur(3px);
      bottom: -30px;
      left: -40px;
      z-index: -1;
    }

    .table thead th {
      border-color: rgba(55, 65, 81, 0.9);
    }

    .table tbody tr {
      border-color: rgba(31, 41, 55, 0.8);
    }

    .table-dark-custom {
      background-color: rgba(15, 23, 42, 0.95);
      color: #e5e7eb;
    }

    .status-badge-open {
      background-color: rgba(34, 197, 94, 0.1);
      color: #bbf7d0;
      border: 1px solid rgba(34, 197, 94, 0.6);
    }

    .status-badge-closed {
      background-color: rgba(248, 113, 113, 0.1);
      color: #fecaca;
      border: 1px solid rgba(248, 113, 113, 0.6);
    }

    .status-badge-flagged {
      background-color: rgba(250, 204, 21, 0.08);
      color: #facc15;
      border: 1px solid rgba(250, 204, 21, 0.6);
    }

    .status-badge-ok {
      background-color: rgba(59, 130, 246, 0.1);
      color: #bfdbfe;
      border: 1px solid rgba(59, 130, 246, 0.7);
    }

    footer {
      background: rgba(15, 23, 42, 0.98);
      border-top: 1px solid rgba(31, 41, 55, 0.9);
      color: #6b7280;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark border-bottom border-secondary">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">
        <span class="text-info">CR</span>MS
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto align-items-lg-center">
          <li class="nav-item">
            <a class="nav-link" href="index.html">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="student-login.html">Student Portal</a>
          </li>
          <li class="nav-item">
            <a class="nav-link active" href="admin-login.html">CR/Admin Portal</a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- Dashboard -->
  <div class="dashboard-wrapper">
    <div class="container">
      <div class="row g-4">

        <!-- Left column -->
        <div class="col-lg-4">
          <div class="position-relative mb-4">
            <div class="hero-blur-orb"></div>
            <div class="hero-blur-orb-2"></div>

            <div class="glass-card p-4 mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <div>
                  <h4 class="mb-1">Hello, CR</h4>
                  <p class="text-secondary mb-0 small">
                    Control the current class attendance session.
                  </p>
                </div>
                <span class="badge badge-soft">Admin Dashboard</span>
              </div>

              <hr class="border-secondary border-opacity-50">

              <div class="mb-3">
                <p class="small text-secondary mb-1">Session status</p>
                <h5 class="mb-2" id="sessionTitle">No active session</h5>
                <p class="small text-secondary mb-2" id="sessionSubtitleText">
                  Class not currently running
                </p>
                <span id="sessionStatusBadge" class="badge rounded-pill status-badge-closed">
                  Closed
                </span>
              </div>

              <div class="d-flex gap-2 mb-3">
                <button id="openSessionBtn" class="btn btn-primary w-50">Open Session</button>
                <button id="closeSessionBtn" class="btn btn-outline-light w-50">Close Session</button>
              </div>

              <p id="sessionInfoText" class="small text-secondary mb-0">
                When the session is open, students can mark attendance from their dashboard.
              </p>
            </div>

            <div class="glass-card p-4">
              <h6 class="mb-3">Quick stats</h6>
              <div class="row text-center g-3">
                <div class="col-4">
                  <p class="small text-secondary mb-1">Present</p>
                  <h5 class="mb-0" id="statPresent">0</h5>
                </div>
                <div class="col-4">
                  <p class="small text-secondary mb-1">Absent</p>
                  <h5 class="mb-0" id="statAbsent">0</h5>
                </div>
                <div class="col-4">
                  <p class="small text-secondary mb-1">Flagged</p>
                  <h5 class="mb-0" id="statFlagged">0</h5>
                </div>
              </div>
              <p class="small text-secondary mt-3 mb-0">
                These values update automatically based on registered students and attendance records.
              </p>
            </div>
          </div>
        </div>

        <!-- Right column -->
        <div class="col-lg-8">
          <div class="glass-card p-4 mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-1">Recent Attendance</h5>
                <p class="small text-secondary mb-0">
                  Latest attendance entries recorded for the current class.
                </p>
              </div>
              <span class="badge badge-soft">Live Activity</span>
            </div>

            <div class="table-responsive mb-3">
              <table class="table table-dark-custom table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th scope="col">Roll No</th>
                    <th scope="col">Name</th>
                    <th scope="col">Device ID</th>
                    <th scope="col">Status</th>
                    <th scope="col">Action</th>
                  </tr>
                </thead>
                <tbody id="flaggedTableBody">
                  <!-- Filled from /api/recent-activity -->
                </tbody>
              </table>
            </div>

            <p class="small text-secondary mb-0">
              Use this list to review recent marks and resolve any suspicious or duplicate entries.
            </p>
          </div>

          <div class="glass-card p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <h5 class="mb-1">Registered Students</h5>
                <p class="small text-secondary mb-0">
                  Example list of students; the search box filters rows on this page.
                </p>
              </div>
              <span class="badge badge-soft">Students</span>
            </div>

            <div class="row mb-3 g-2">
              <div class="col-md-4">
                <input
                  type="text"
                  id="searchInput"
                  class="form-control form-control-sm"
                  placeholder="Search by name or roll">
              </div>
            </div>

            <div class="table-responsive">
              <table class="table table-dark-custom table-hover align-middle mb-0" id="studentsTable">
                <thead>
                  <tr>
                    <th scope="col">Roll No</th>
                    <th scope="col">Name</th>
                    <th scope="col">Device ID</th>
                    <th scope="col">Last Status</th>
                  </tr>
                </thead>
                <tbody id="studentsTableBody">
                </tbody>

              </table>
            </div>

            <p class="small text-secondary mt-3 mb-0">
              This example list is for UI only; your actual student records are stored in the database.
            </p>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="py-3">
    <div class="container text-center small">
      CRMS &copy; 2025 – Admin Dashboard
    </div>
  </footer>

  <!-- Bootstrap JS Bundle (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  const openSessionBtn = document.getElementById('openSessionBtn');
  const closeSessionBtn = document.getElementById('closeSessionBtn');
  const statusBadge = document.getElementById('sessionStatusBadge');
  const infoText = document.getElementById('sessionInfoText');
  const sessionTitle = document.getElementById('sessionTitle');
  const sessionSubtitleText = document.getElementById('sessionSubtitleText');

  const statPresent = document.getElementById('statPresent');
  const statAbsent = document.getElementById('statAbsent');
  const statFlagged = document.getElementById('statFlagged');

  let currentSession = null;

  async function askSessionConfig() {
    const defaultCourse = 'Web Technologies Lab';
    const defaultDuration = 60;
    const defaultClassTime = '11:30 – 02:30';

    const course = prompt('Enter course name for this session:', defaultCourse);
    if (!course || !course.trim()) {
      alert('Session not created: course name is required.');
      return null;
    }

    const durationStr = prompt(
      'Enter session duration in minutes (for how long attendance stays open):',
      String(defaultDuration)
    );
    const duration = parseInt(durationStr, 10);
    if (isNaN(duration) || duration <= 0) {
      alert('Session not created: duration must be a positive number.');
      return null;
    }

    const classTime = prompt(
      'Enter class time to display (e.g. "11:30 – 02:30"):',
      defaultClassTime
    );
    const classTimeText =
      classTime && classTime.trim() ? classTime.trim() : defaultClassTime;

    return { course: course.trim(), duration, classTimeText };
  }

  function updateSessionUI() {
    if (currentSession) {
      statusBadge.textContent = 'Open';
      statusBadge.classList.remove('status-badge-closed');
      statusBadge.classList.add('status-badge-open');

      sessionTitle.textContent = currentSession.course + ' – Active Session';
      sessionSubtitleText.textContent =
        currentSession.classTimeText || 'Class time not set';

      infoText.textContent = `Session ${currentSession.session_code} is open until ${new Date(
        currentSession.end_time
      ).toLocaleTimeString()}.`;
    } else {
      statusBadge.textContent = 'Closed';
      statusBadge.classList.remove('status-badge-open');
      statusBadge.classList.add('status-badge-closed');

      sessionTitle.textContent = 'No active session';
      sessionSubtitleText.textContent = 'Class not currently running';

      infoText.textContent =
        'Session is closed. Students cannot mark attendance until you open a new session.';
    }
  }

  async function fetchActiveSession() {
    try {
      const res = await fetch('http://localhost:5000/api/active-sessions');
      const data = await res.json();
      currentSession =
        Array.isArray(data) && data.length > 0
          ? {
              ...data[0],
              classTimeText:
                localStorage.getItem('crmsClassTime') || 'Class time not set'
            }
          : null;
      updateSessionUI();
    } catch (err) {
      console.error('Failed to load active session', err);
    }
  }

  // Open session
  openSessionBtn.addEventListener('click', async () => {
    try {
      const config = await askSessionConfig();
      if (!config) return;

      const createdBy = localStorage.getItem('crmsRollNo') || '2023F-BCS-096';

      const res = await fetch('http://localhost:5000/api/create-session', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          course: config.course,
          duration: config.duration,
          createdBy
        })
      });

      const data = await res.json();

      if (!res.ok) {
        alert(data.message || 'Failed to create session');
        return;
      }

      localStorage.setItem('crmsClassTime', config.classTimeText);

      currentSession = {
        id: data.sessionId,
        session_code: data.sessionCode,
        course: config.course,
        start_time: data.startTime,
        end_time: data.endTime,
        status: 'active',
        classTimeText: config.classTimeText
      };

      updateSessionUI();
      alert('Session created with code: ' + data.sessionCode);
      await loadDashboardStats();
      await loadRecentActivity();
    } catch (err) {
      console.error(err);
      alert('Server error while creating session');
    }
  });

  // Close session
  closeSessionBtn.addEventListener('click', async () => {
    if (!currentSession) {
      alert('No active session to close.');
      return;
    }

    if (
      !confirm(
        'Close current session ' + currentSession.session_code + '?'
      )
    ) {
      return;
    }

    try {
      const res = await fetch(
        'http://localhost:5000/api/end-session/' + currentSession.id,
        { method: 'POST' }
      );
      const data = await res.json();

      if (!res.ok) {
        alert(data.message || 'Failed to end session');
        return;
      }

      currentSession = null;
      updateSessionUI();
      alert('Session ended successfully');
      await loadDashboardStats();
      await loadRecentActivity();
    } catch (err) {
      console.error(err);
      alert('Server error while ending session');
    }
  });

  // Quick stats
  async function loadDashboardStats() {
    try {
      const res = await fetch('http://localhost:5000/api/dashboard-stats');
      if (!res.ok) return;
      const stats = await res.json();

      const presentCount = stats.presentCount || 0;
      const absentCount = stats.absentCount || 0;
      const flaggedCount = stats.flaggedCount || 0;

      statPresent.textContent = presentCount;
      statAbsent.textContent = absentCount;
      statFlagged.textContent = flaggedCount;
    } catch (err) {
      console.error('Failed to load dashboard stats', err);
    }
  }

  // Recent activity
  async function loadRecentActivity() {
    try {
      const res = await fetch('http://localhost:5000/api/recent-activity');
      if (!res.ok) return;
      const list = await res.json();

      const tbody = document.getElementById('flaggedTableBody');
      if (!tbody) return;

      tbody.innerHTML = '';

      if (!Array.isArray(list) || list.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="5" class="small text-secondary text-center">
            No attendance records yet.
          </td>
        `;
        tbody.appendChild(tr);
        return;
      }

      list.forEach((rec) => {
        const tr = document.createElement('tr');
        tr.dataset.id = rec.id;

        let label = 'Present';
        let badgeClass = 'status-badge-ok';

        if (rec.status === 'removed') {
          label = 'Removed';
          badgeClass = 'status-badge-closed';
        } else if (rec.status === 'approved') {
          label = 'Approved';
          badgeClass = 'status-badge-ok';
        } else if (rec.status === 'pending' && rec.flag_reason) {
          label = rec.flag_reason;
          badgeClass = 'status-badge-flagged';
        }

        tr.innerHTML = `
          <td>${rec.student_roll_no}</td>
          <td>${rec.full_name}</td>
          <td>${rec.device_id}</td>
          <td>
            <span class="badge rounded-pill ${badgeClass}">
              ${label}
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-outline-light me-1 btn-approve"${
              rec.status === 'removed' ? ' disabled' : ''
            }>Approve</button>
            <button class="btn btn-sm btn-outline-light btn-remove"${
              rec.status === 'removed' ? ' disabled' : ''
            }>Remove</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch (err) {
      console.error('Failed to load recent activity', err);
    }
  }

  // Row actions
  const flaggedTableBody = document.getElementById('flaggedTableBody');

  flaggedTableBody.addEventListener('click', async function (e) {
    const row = e.target.closest('tr');
    if (!row) return;
    const id = row.dataset.id;
    if (!id) return;

    // Approve
    if (e.target.classList.contains('btn-approve')) {
      try {
        const res = await fetch(
          `http://localhost:5000/api/attendance/${id}/approve`,
          { method: 'POST' }
        );
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || 'Failed to approve attendance');
          return;
        }
        await loadDashboardStats();
        await loadRecentActivity();
      } catch (err) {
        console.error(err);
        alert('Server error while approving attendance');
      }
    }

    // Remove
    if (e.target.classList.contains('btn-remove')) {
      if (!confirm('Remove this attendance record?')) return;
      try {
        const res = await fetch(
          `http://localhost:5000/api/attendance/${id}/remove`,
          { method: 'POST' }
        );
        const data = await res.json();
        if (!res.ok) {
          alert(data.message || 'Failed to remove attendance');
          return;
        }
        await loadDashboardStats();
        await loadRecentActivity();
      } catch (err) {
        console.error(err);
        alert('Server error while removing attendance');
      }
    }
  });

  // Registered students (real-time)
  const searchInput = document.getElementById('searchInput');
  const studentsTableBody = document
    .getElementById('studentsTable')
    .getElementsByTagName('tbody')[0];

  async function loadStudents() {
    try {
      const res = await fetch('http://localhost:5000/api/students');
      if (!res.ok) return;
      const students = await res.json();

      studentsTableBody.innerHTML = '';

      if (!Array.isArray(students) || students.length === 0) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="4" class="small text-secondary text-center">
            No students found in database.
          </td>
        `;
        studentsTableBody.appendChild(tr);
        return;
      }

      students.forEach((stu) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${stu.roll_number}</td>
          <td>${stu.full_name}</td>
          <td>-</td>
          <td><span class="badge rounded-pill status-badge-ok">N/A</span></td>
        `;
        studentsTableBody.appendChild(tr);
      });
    } catch (err) {
      console.error('Failed to load students', err);
    }
  }

  searchInput.addEventListener('keyup', function () {
    const filter = searchInput.value.toLowerCase();
    const rows = studentsTableBody.getElementsByTagName('tr');

    for (let i = 0; i < rows.length; i++) {
      const text = rows[i].textContent.toLowerCase();
      rows[i].style.display = text.indexOf(filter) > -1 ? '' : 'none';
    }
  });

  (async function init() {
    await fetchActiveSession();
    await loadDashboardStats();
    await loadRecentActivity();
    await loadStudents();
  })();
</script>

</body>
</html>
